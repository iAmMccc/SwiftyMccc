# 推送的扩展能力 — 打造安全的通知体验



todo

1. 如何下载附件内容，做推送展示？

2. 安全性管理

   





------

## 一、什么是 Notification Service Extension？

Notification Service Extension 是一个独立运行的扩展模块，系统在通知即将展示之前调用它，开发者可以在这里：

- 对通知内容进行修改（标题、正文、声音等）
- 动态添加附件资源（图片、音视频等）
- 对本地通知内容进行加密解密处理
- 对通知进行内容校验和安全检查

------

## 二、创建 Notification Service Extension

1. 在 Xcode 中新增 Target，选择 **Notification Service Extension**。
2. 系统自动生成一个继承 `UNNotificationServiceExtension` 的类，重写以下方法：

```
swift


复制编辑
override func didReceive(
    _ request: UNNotificationRequest, 
    withContentHandler contentHandler: @escaping (UNNotificationContent) -> Void
) {
    // 对通知内容进行处理
}
```

1. 处理完通知内容后，调用 `contentHandler` 传回修改后的通知。

------

## 三、典型应用场景示例

### 1. 修改通知标题和正文

```
swift


复制编辑
override func didReceive(_ request: UNNotificationRequest,
                         withContentHandler contentHandler: @escaping (UNNotificationContent) -> Void) {
    let bestContent = (request.content.mutableCopy() as? UNMutableNotificationContent)
    bestContent?.title = "【重要提示】" + (bestContent?.title ?? "")
    bestContent?.body += "\n请及时查看。"
    contentHandler(bestContent ?? request.content)
}
```

### 2. 动态添加本地附件资源

```
swift


复制编辑
if let url = Bundle.main.url(forResource: "localImage", withExtension: "jpg") {
    do {
        let attachment = try UNNotificationAttachment(identifier: "image", url: url, options: nil)
        bestContent?.attachments = [attachment]
    } catch {
        print("附件添加失败: \(error)")
    }
}
contentHandler(bestContent ?? request.content)
```

------

## 四、使用限制和注意事项

| 限制项                    | 说明                                                        |
| ------------------------- | ----------------------------------------------------------- |
| 执行时间限制              | 系统只给约 30 秒的时间执行，超时将使用原始通知内容。        |
| 资源消耗限制              | 避免过度消耗 CPU、内存、网络资源，影响系统性能。            |
| 异步处理建议              | 推荐使用异步加载资源，避免阻塞主线程。                      |
| 失败回退                  | 处理失败或超时时，通知按原始内容展示，不影响用户接收通知。  |
| 仅能修改内容，无法控制 UI | 通知 UI 展示需用 Notification Content Extension 实现。      |
| 独立进程环境              | 扩展和主 App 互相隔离，通信需用共享容器、App Group 等机制。 |



------

## 五、安全建议

- 对敏感信息在通知内容中进行加密，扩展中进行解密处理。
- 严格校验通知内容合法性，防止恶意注入。
- 不在扩展内明文存储密钥，建议用 Keychain 或安全存储。
- 控制扩展逻辑简单、健壮，防止因异常影响通知体验。

------

## 六、配置要点

- 主 App 和扩展 Target 都需开启推送功能。
- 本地通知或远程通知的 `mutable-content` 字段设为 1，表示允许调用服务扩展处理通知内容。
- 通过扩展的 `Info.plist` 配置扩展基本信息。

------

## 七、总结

Notification Service Extension 让开发者有能力在通知内容展示前对通知进行安全、灵活的动态处理，提升通知内容的准确性和用户体验。
它与 Notification Content Extension 搭配使用，可以共同打造出既个性化又安全的推送体系。
