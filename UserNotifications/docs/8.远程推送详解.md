# 远程推送

远程推送是现代移动应用与用户沟通的核心机制之一。它允许服务器主动向用户设备发送消息，提醒、更新或触发用户操作，而无需用户主动打开应用。



## 一、远程推送的基本工作流程

1. **服务器准备通知内容**
   服务器根据业务逻辑生成推送消息的 payload，通常包含标题（title）、正文（body）、声音（sound）、badge 等字段，以及可选的自定义数据。
2. **向推送服务请求发送**
   服务器将推送请求发送到苹果的 APNs（Apple Push Notification service）。
3. **APNs 转发推送消息**
   APNs 负责将通知安全、高效地转发到指定设备。
4. **设备接收并展示通知**
   设备收到推送后，系统根据通知内容生成并展示通知样式。

------

## 二、远程推送的内容限制与挑战

- **Payload 大小限制**
  APNs 对单条推送通知的 payload 大小有限制（一般为 4KB），限制了通知内容的丰富度。
- **静态内容限制**
  通知内容一般由服务器生成，无法根据用户设备状态或上下文动态调整。
- **富媒体内容处理复杂**
  图片、视频等附件无法直接包含在推送中，需额外下载处理。
- **安全隐私风险**
  远程推送中可能包含敏感数据，网络传输及存储存在隐私泄露风险。

------

## 三、为了解决上述问题——Notification Service Extension

苹果推出了 **Notification Service Extension（通知服务扩展）**，让开发者在推送消息到达设备时有机会对通知内容进行“最后一公里”的动态处理。

------

## 四、Notification Service Extension 的作用

- **动态修改通知内容**
  可以根据设备状态、用户偏好等条件修改通知标题、正文等。
- **异步下载并添加附件**
  在通知展示前下载图片、视频等富媒体，提升视觉体验。
- **解密加密通知内容**
  服务器加密敏感数据，扩展负责本地解密，保障隐私安全。
- **拦截或过滤恶意内容**
  对通知内容做安全校验，防止恶意通知影响用户。

------

## 五、Notification Service Extension 的工作流程

1. APNs 推送包含 `"mutable-content": 1` 标记，告诉系统允许调用扩展。
2. 设备收到推送后，系统启动扩展进程，调用 `didReceive(_:withContentHandler:)` 方法。
3. 开发者在该方法内对通知内容进行修改和处理。
4. 处理完成后调用 `contentHandler`，将修改后的内容提交系统展示。
5. 系统展示最终的通知样式给用户。

------

## 六、开发步骤简述

1. **在项目中新增 Notification Service Extension target。**
2. **实现扩展的 `didReceive(_:withContentHandler:)` 方法，处理通知内容。**
3. **确保推送 payload 中包含 `"mutable-content": 1`。**
4. **调试验证扩展功能正常。**

------

## 七、示例代码片段

```
swift


复制编辑
override func didReceive(_ request: UNNotificationRequest,
                         withContentHandler contentHandler: @escaping (UNNotificationContent) -> Void) {
    guard let bestAttemptContent = (request.content.mutableCopy() as? UNMutableNotificationContent) else {
        contentHandler(request.content)
        return
    }

    // 例如，添加前缀到标题
    bestAttemptContent.title = "[重要] " + bestAttemptContent.title

    // 异步下载图片附件示例
    if let urlString = bestAttemptContent.userInfo["image-url"] as? String,
       let url = URL(string: urlString) {
        URLSession.shared.dataTask(with: url) { data, _, error in
            if let data = data, error == nil {
                let tmpDir = URL(fileURLWithPath: NSTemporaryDirectory())
                let tmpFile = tmpDir.appendingPathComponent("image.jpg")
                try? data.write(to: tmpFile)
                if let attachment = try? UNNotificationAttachment(identifier: "image", url: tmpFile, options: nil) {
                    bestAttemptContent.attachments = [attachment]
                }
            }
            contentHandler(bestAttemptContent)
        }.resume()
    } else {
        contentHandler(bestAttemptContent)
    }
}
```

------

## 八、总结

通过 Notification Service Extension，远程推送不再局限于服务器端的静态内容，而能实现动态、安全和丰富的通知体验，大大提升用户对通知的关注度和互动性。
