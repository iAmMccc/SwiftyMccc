# Swift Macros - å®ä¹‹å…¨è²Œ

## 1. å®çš„å®šä¹‰

**Swift å®ï¼ˆMacroï¼‰** æ˜¯ä¸€ç§åœ¨ç¼–è¯‘æœŸæ‰§è¡Œçš„ä»£ç ç”Ÿæˆæœºåˆ¶ã€‚å¼€å‘è€…å¯ä»¥é€šè¿‡ç®€æ´çš„è¯­æ³•æ ‡è®°ï¼Œåœ¨æºä»£ç ä¸­è‡ªåŠ¨æ’å…¥ã€æ›¿æ¢æˆ–è¡¥å……é€»è¾‘ï¼Œä»Žè€Œå®žçŽ°æ ·æ¿ä»£ç çš„è‡ªåŠ¨åŒ–ã€‚

Swift å®å»ºç«‹åœ¨è¯­æ³•æ ‘ä¸Žç±»åž‹ç³»ç»Ÿä¹‹ä¸Šï¼Œå…·å¤‡**ç±»åž‹å®‰å…¨**ã€**è¯­ä¹‰æ˜Žç¡®**ä¸Ž**å¯é¢„æµ‹**çš„å…ƒç¼–ç¨‹ç‰¹æ€§ã€‚

![å®ç»“æž„è§£æž](../images/å®ç»“æž„è§£æž.png)

**ä¸ºä»€ä¹ˆä½¿ç”¨å®ï¼Ÿ**

Swift å®çš„ä¼˜åŠ¿ä½“çŽ°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

- **ç¼–è¯‘æœŸæ‰§è¡Œï¼Œé›¶è¿è¡Œæ—¶å¼€é”€**
  å®åœ¨ç¼–è¯‘é˜¶æ®µå®Œæˆä»£ç å±•å¼€ï¼Œé¿å…è¿è¡Œæ—¶åå°„æˆ–åŠ¨æ€è°ƒç”¨çš„æ€§èƒ½è´Ÿæ‹…ã€‚
- **å‡å°‘æ ·æ¿ä»£ç ï¼Œæå‡å¼€å‘æ•ˆçŽ‡**
  æ— éœ€æ‰‹åŠ¨å®žçŽ° `Equatable`ã€`Codable`ã€ç›‘å¬å™¨ç­‰é‡å¤æ€§é€»è¾‘ï¼Œå®å¯ä»¥è‡ªåŠ¨ç”Ÿæˆè¿™äº›ä»£ç ã€‚
- **ç±»åž‹å®‰å…¨ï¼Œè¯­æ³•æ— ç¼è¡”æŽ¥**
  å®å±•å¼€åŽçš„ä»£ç ä¸Žæ‰‹å†™ä»£ç ä¸€æ ·ï¼Œä¼šç»åŽ†å®Œæ•´çš„è¯­æ³•ä¸Žç±»åž‹éªŒè¯ï¼Œç¡®ä¿å¯é æ€§ä¸Žä¸€è‡´æ€§ã€‚



## 2. å®çš„è®¾è®¡åŽŸåˆ™

Swift å®çš„è®¾è®¡ç§‰æ‰¿â€œ**æ˜¾å¼ã€å®‰å…¨ã€å¯é¢„æµ‹**â€ä¸‰å¤§åŽŸåˆ™ï¼Œé¿å…â€œé­”æ³•å¼â€çš„éšå¼è¡Œä¸ºï¼š

| åŽŸåˆ™           | è¯´æ˜Ž                                                         |
| -------------- | ------------------------------------------------------------ |
| **æ˜¾å¼è°ƒç”¨**   | å®å¿…é¡»é€šè¿‡æ˜Žç¡®è¯­æ³•æ ‡è®°ä½¿ç”¨ï¼Œå¼€å‘è€…æ¸…æ™°å¯è§ã€‚                 |
| **ç±»åž‹æ£€æŸ¥**   | å®ç”Ÿæˆçš„ä»£ç ä¼šç»è¿‡å®Œæ•´çš„ç±»åž‹ç³»ç»ŸéªŒè¯ï¼Œä¸ä¼šç»•è¿‡è¯­è¨€è§„åˆ™ã€‚     |
| **å¯é¢„æµ‹å±•å¼€** | å®çš„å±•å¼€é€»è¾‘å¿…é¡»æ˜¯ç¨³å®šçš„ã€å¯é¢„æœŸçš„ï¼Œç»“æžœä¸ä¼šå› å¤–éƒ¨çŽ¯å¢ƒè€Œæ”¹å˜ã€‚ |

**å®ä¸æ˜¯é­”æ³•**ï¼Œå®ƒå¹¶ä¸ç¥žç§˜ï¼Œä¹Ÿä¸å‡Œé©¾äºŽè¯­è¨€è§„åˆ™ä¹‹ä¸Šã€‚ä½ å†™ä¸‹çš„æ¯ä¸€ä¸ªå®è°ƒç”¨ï¼Œéƒ½å°†ä»¥å¯è¯»ã€å¯æµ‹ã€å¯è°ƒè¯•çš„æ–¹å¼æ’å…¥æºä»£ç ä¸­ã€‚



## 3. å®çš„åŽŸç†

Swift å®åŸºäºŽ**ç¼–è¯‘å™¨æ’ä»¶ï¼ˆCompiler Plug-inï¼‰**æœºåˆ¶è¿è¡Œï¼Œæ•´ä¸ªè¿‡ç¨‹å‘ç”Ÿåœ¨**ç¼–è¯‘æœŸ**ï¼Œå¹¶å—åˆ°ä¸¥æ ¼çš„æ²™ç›’é™åˆ¶ã€‚

### å®çš„å±•å¼€æµç¨‹

![å®çš„æ‰©å±•](../images/å®çš„æ‰©å±•.png)

1. **æå–å®è°ƒç”¨**ï¼šç¼–è¯‘å™¨è¯†åˆ«æºç ä¸­çš„å®è¯­æ³•ï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„åŽŸå§‹è¯­æ³•æ ‘ï¼ˆRaw Syntax Treeï¼‰ã€‚

2. **å‘é€åˆ°å®æ’ä»¶**ï¼šå®è¯­æ³•æ ‘è¢«å‘é€è‡³å¯¹åº”æ’ä»¶ï¼Œè¯¥æ’ä»¶åœ¨æ²™ç›’ä¸­ä»¥ç‹¬ç«‹è¿›ç¨‹è¿è¡Œã€‚

3. **æ‰§è¡Œå®é€»è¾‘**ï¼šæ’ä»¶å¤„ç†è¯­æ³•æ ‘å¹¶ç”Ÿæˆæ–°çš„ä»£ç ç‰‡æ®µï¼ˆè¯­æ³•èŠ‚ç‚¹ï¼‰ã€‚

4. **æ’å…¥å¹¶ç»§ç»­ç¼–è¯‘**ï¼šæ–°ç”Ÿæˆçš„è¯­æ³•èŠ‚ç‚¹è¢«æ’å…¥åŽŸå§‹æºç ï¼Œå‚ä¸ŽåŽç»­çš„ç¼–è¯‘è¿‡ç¨‹ã€‚



### å®çš„å®‰å…¨æ€§ä¸Žçº¯ç²¹æ€§

ä¸ºäº†ç¡®ä¿å®ç³»ç»Ÿçš„ **å®‰å…¨ã€ç¨³å®šä¸Žå¯æŽ§æ€§**ï¼ŒSwift ä»Žä¸¤ä¸ªç»´åº¦å¯¹å®è¡Œä¸ºåšå‡ºçº¦æŸï¼š

#### ç³»ç»Ÿéš”ç¦»ï¼šæ²™ç›’æœºåˆ¶

æ‰€æœ‰å®æ’ä»¶è¿è¡Œåœ¨**ç‹¬ç«‹çš„æ²™ç›’è¿›ç¨‹**ä¸­ï¼ŒSwift å¯¹å…¶èƒ½åŠ›è¿›è¡Œäº†ä¸¥æ ¼é™åˆ¶ï¼š

- âœ–ï¸ ç¦æ­¢è®¿é—®æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ `FileManager`ï¼‰
- âœ–ï¸ ç¦æ­¢å‘èµ·ç½‘ç»œè¯·æ±‚
- âœ–ï¸ ç¦æ­¢è°ƒç”¨ç³»ç»Ÿçº§ API

è¿™äº›é™åˆ¶æ˜¯**ç¼–è¯‘å™¨å±‚é¢çš„å¼ºåˆ¶è§„å®š**ï¼Œä¸€æ—¦è®¿é—®å—é™èµ„æºï¼Œä¼šç«‹å³æŠ¥é”™ï¼Œä¾‹å¦‚ï¼š

```
"The file â€œxxxâ€ couldnâ€™t be opened because you donâ€™t have permission to view it."
```

å› æ­¤ï¼Œå³ä½¿ä½¿ç”¨ç¬¬ä¸‰æ–¹å®æ’ä»¶ï¼Œä¹Ÿæ— éœ€æ‹…å¿ƒå…¶åœ¨èƒŒåŽæ‰§è¡ŒæœªæŽˆæƒçš„æ“ä½œã€‚



#### è®¾è®¡å“²å­¦ï¼šçº¯ç²¹æ€§åŽŸåˆ™

Swift é¼“åŠ±å°†å®è§†ä¸º**çº¯å‡½æ•°** â€”â€” **ç›¸åŒè¾“å…¥å§‹ç»ˆç”Ÿæˆç›¸åŒè¾“å‡º**ã€‚è¿™æœ‰åŠ©äºŽï¼š

- æé«˜å®è¡Œä¸ºçš„å¯é¢„æµ‹æ€§
- é¿å…æž„å»ºç»“æžœå› çŽ¯å¢ƒä¸åŒè€Œå˜åŒ–
- æ”¯æŒç¼–è¯‘å™¨ç¼“å­˜å®ç»“æžœï¼Œæå‡æ€§èƒ½

**æŽ¨èåšæ³•**

- âœ”ï¸ ä»…ä¾èµ–ç¼–è¯‘å™¨ä¼ å…¥çš„è¯­æ³•æ ‘ä¸Žä¸Šä¸‹æ–‡
- âœ”ï¸ é¿å…è®¿é—®ç³»ç»ŸçŽ¯å¢ƒã€ç½‘ç»œã€æ–‡ä»¶
- âœ”ï¸ ç”Ÿæˆç¨³å®šã€å¯æµ‹ã€å¯é‡çŽ°çš„ä»£ç 

**ä¸å»ºè®®è¡Œä¸º**

- âœ–ï¸ ä½¿ç”¨ `UUID()` æˆ– `Date()` ç­‰ç”ŸæˆåŠ¨æ€å€¼
- âœ–ï¸ ä½¿ç”¨éšæœºæ•°ä½œä¸ºé»˜è®¤å€¼
- âœ–ï¸ åœ¨å¤šä¸ªå®ä¹‹é—´å…±äº«å…¨å±€ä¸Šä¸‹æ–‡æˆ–éšå¼çŠ¶æ€

è¿™äº›è¡Œä¸ºè™½ç„¶ **æŠ€æœ¯ä¸Šå…è®¸**ï¼Œä½†ä¼šç ´åå®çš„ä¸€è‡´æ€§ï¼Œå¯¼è‡´éš¾ä»¥è°ƒè¯•ã€ä¸å¯å¤çŽ°çš„æž„å»ºç»“æžœã€‚

## 4. å®è§’è‰²ä¸Žå‘½åè¯´æ˜Žç¬¦ï¼šSwift å®çš„èŒè´£ä¸Žå‘½åæŽ§åˆ¶

Swift å®å¹¶éžåƒç¯‡ä¸€å¾‹ï¼Œå®ƒå…·å¤‡æ˜Žç¡®çš„**èŒè´£åˆ’åˆ†**ï¼Œè¿™ç§èŒè´£ç”±ç¼–è¯‘å™¨é€šè¿‡ä¸€å¥—ç§°ä¸º **å®è§’è‰²ï¼ˆMacro Roleï¼‰** çš„æœºåˆ¶è¯†åˆ«å’Œæ‰§è¡Œã€‚

### 4.1 å®è§’è‰²ï¼šSwift å®çš„åŠŸèƒ½æ ‡è¯†

å®è§’è‰²å†³å®šäº†ä¸€ä¸ªå®å¯ä»¥åšä»€ä¹ˆã€‚Swift ä¸­çš„å®ä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼š

- **ç‹¬ç«‹å®ï¼ˆFreestandingï¼‰**ï¼šä½¿ç”¨ `@freestanding(...)` æ ‡è®°ï¼Œç‹¬ç«‹äºŽä»»ä½•å·²æœ‰å£°æ˜Žï¼Œé€‚åˆç”Ÿæˆè¡¨è¾¾å¼æˆ–æ–°çš„å£°æ˜Žè¯­å¥ã€‚
- **ç»‘å®šå®ï¼ˆAttachedï¼‰**ï¼šä½¿ç”¨ `@attached(...)` æ ‡è®°ï¼Œé™„ç€åœ¨å·²æœ‰å£°æ˜Žï¼ˆå¦‚ç±»åž‹ã€å‡½æ•°ã€å±žæ€§ï¼‰ä¸Šï¼Œç”¨äºŽæ‰©å±•æˆ–ä¿®æ”¹å®ƒä»¬çš„ç»“æž„ã€‚

æ¯ç§å®è§’è‰²éƒ½å¯¹åº”ç‰¹å®šçš„åè®®ï¼Œå®šä¹‰å…¶å±•å¼€è¡Œä¸ºï¼š

| å®è§’è‰²                       | æè¿°             | åè®®å                 | ç¤ºä¾‹ç”¨é€”                      |
| ---------------------------- | ---------------- | ---------------------- | ----------------------------- |
| `@freestanding(expression)`  | è¡¨è¾¾å¼ç‹¬ç«‹å®     | `ExpressionMacro`      | æ›¿æ¢æˆ–æ‰©å±•è¡¨è¾¾å¼              |
| `@freestanding(declaration)` | å£°æ˜Žå¼ç‹¬ç«‹å®     | `DeclarationMacro`     | æ·»åŠ å˜é‡ã€å‡½æ•°ã€ç±»åž‹å£°æ˜Ž      |
| `@attached(member)`          | æˆå‘˜ç»‘å®šå®       | `MemberMacro`          | å‘ç±»åž‹ä¸­æ³¨å…¥å±žæ€§ã€æ–¹æ³•ç­‰æˆå‘˜  |
| `@attached(peer)`            | å¯¹ç­‰ç»‘å®šå®       | `PeerMacro`            | åœ¨å£°æ˜Žæ—æ’å…¥å¹¶åˆ—çš„æ–°å£°æ˜Ž      |
| `@attached(accessor)`        | è®¿é—®å™¨ç»‘å®šå®     | `AccessorMacro`        | è‡ªåŠ¨ç”Ÿæˆ get/set ç­‰å±žæ€§è®¿é—®å™¨ |
| `@attached(extension)`       | æ‰©å±•ç»‘å®šå®       | `ExtensionMacro`       | ç”Ÿæˆæ‰©å±•ï¼ˆextensionï¼‰         |
| `@attached(memberAttribute)` | æˆå‘˜å±žæ€§ç»‘å®šå®   | `MemberAttributeMacro` | ä¿®æ”¹æˆå‘˜çš„æ³¨è§£ã€å±žæ€§ç­‰        |
| `@attached(body)`            | å‡½æ•°ä½“æ›¿æ¢ç»‘å®šå® | `BodyMacro`            | æ›¿æ¢è®¡ç®—å±žæ€§æˆ–å‡½æ•°çš„å®žçŽ°ä½“    |

> ç‹¬ç«‹å®ä»¥ `#å®å(...)` ä½¿ç”¨ï¼Œç»‘å®šå®ä»¥ `@å®å(...)` ä½¿ç”¨ã€‚

è¿™äº›è§’è‰²ä¸º Swift å®æž„å»ºèµ·äº†æ¸…æ™°çš„èŒè´£ä½“ç³» â€”â€” æ¯ä¸ªå®è§’è‰²éƒ½å¯¹åº”ä¸€ç±»è¯­æ³•ç»“æž„çš„ç”Ÿæˆæˆ–ä¿®æ”¹è¡Œä¸ºã€‚



### 4.2 å‘½åè¯´æ˜Žç¬¦ï¼šç»‘å®šå®ä¸­çš„å‘½åæŽ§åˆ¶å™¨

å¯¹äºŽä¼šç”Ÿæˆ **å…·åå®žä½“ï¼ˆå¦‚å±žæ€§ã€å‡½æ•°ã€ç±»åž‹ï¼‰** çš„å®ï¼ŒSwift æä¾›äº†å¦ä¸€å¥—æœºåˆ¶æ¥è¿›ä¸€æ­¥æŽ§åˆ¶â€œç”Ÿæˆå‡ºæ¥çš„ä¸œè¥¿å«ä»€ä¹ˆâ€ï¼Œè¿™å°±æ˜¯ **å‘½åè¯´æ˜Žç¬¦ï¼ˆName Specifierï¼‰**ã€‚

åœ¨ç»‘å®šå®ï¼ˆä¾‹å¦‚ `MemberMacro`ã€`AccessorMacro`ï¼‰ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ `expanded` æ–¹æ³•è¿”å›žå­—ç¬¦ä¸²å½¢å¼çš„å£°æ˜Žä»£ç ã€‚ä½†å¦‚æžœä¸æ˜Žç¡®å‘½åï¼Œç¼–è¯‘å™¨å°†è§†è¿™äº›å†…å®¹ä¸º **åŒ¿åç”Ÿæˆ**ï¼Œä»Žè€Œå¸¦æ¥å‡ ä¸ªé—®é¢˜ï¼š

- æ— æ³•åœ¨è¯­ä¹‰å±‚é¢è¯†åˆ«ç”Ÿæˆæˆå‘˜çš„åç§°ï¼›
- ä»£ç è¡¥å…¨ã€è·³è½¬ã€æ–‡æ¡£å·¥å…·æ”¯æŒä¸ä½³ï¼›
- å¤šä¸ªå®åŒæ—¶ç”Ÿæˆä»£ç æ—¶å®¹æ˜“å‘ç”Ÿå‘½åå†²çªï¼›
- å…¶ä»–å®æ— æ³•å¯é åœ°å¼•ç”¨è¿™äº›ç”Ÿæˆå†…å®¹ã€‚

ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼ŒSwift å¼•å…¥äº† **å‘½åè¯´æ˜Žç¬¦** æœºåˆ¶ï¼Œç”¨äºŽç²¾ç¡®æŒ‡å®šå®ç”Ÿæˆçš„å®žä½“åç§°ã€‚ä¾‹å¦‚ï¼š

```
@attached(extension, names: named(==))
```

è¿™è¡¨ç¤ºï¼šå®å°†ç”Ÿæˆä¸€ä¸ªå…·åä¸º `==` çš„æˆå‘˜æ–¹æ³•ã€‚



#### å‘½åè¯´æ˜Žç¬¦çš„ç§ç±»ä¸Žç”¨é€”

| å‘½åè¯´æ˜Žç¬¦        | å…¸åž‹ç”¨é€”               | åŽŸå§‹å£°æ˜Ž           | å®ç”Ÿæˆç»“æžœ                           |
| ----------------- | ---------------------- | ------------------ | ------------------------------------ |
| `named("...")`    | è®¾å®šå›ºå®šåç§°           | `struct MyView {}` | `static func makePreview()`          |
| `prefixed("...")` | ç»™ç”Ÿæˆæˆå‘˜åŠ å‰ç¼€       | `var name: String` | `var debug_name: String`             |
| `suffixed("...")` | ç»™ç”Ÿæˆæˆå‘˜åŠ åŽç¼€       | `func save()`      | `func saveAsync()`                   |
| `overloaded`      | æ·»åŠ é‡è½½ç‰ˆæœ¬           | `func log()`       | `func log(level: LogLevel)`          |
| `arbitrary`       | è‡ªå®šä¹‰å‘½åï¼ˆå¤æ‚åœºæ™¯ï¼‰ | `struct User {}`   | `_UserFlagsHelper`, `internalMap` ç­‰ |



## 5. å®åè®®ï¼šå†³å®šå®è¡Œä¸ºçš„åŠŸèƒ½æŽ¥å£

Swift å®çš„åŠŸèƒ½æ˜¯å»ºç«‹åœ¨ä¸€å¥—æ˜Žç¡®åˆ†å±‚çš„åè®®ä½“ç³»ä¸Šçš„ã€‚è¿™äº›åè®®å®šä¹‰äº†å®çš„ **åŸºæœ¬è¡Œä¸º**ã€**é€‚ç”¨åœºæ™¯**ï¼Œä»¥åŠ **å¦‚ä½•å“åº”ç¼–è¯‘å™¨çš„å®å±•å¼€è¯·æ±‚**ã€‚

### 5.1 å®çš„åŸºç¡€åè®®ï¼š`Macro`

æ‰€æœ‰ Swift å®éƒ½éµå¾ª `Macro` åè®®ï¼Œå®ƒæ˜¯å®ä½“ç³»çš„æ ¹åŸºï¼Œå®šä¹‰äº†å®çš„åŸºæœ¬èƒ½åŠ›å’Œé»˜è®¤è¡Œä¸ºã€‚

```
public protocol Macro {
  /// æŽ§åˆ¶å®å±•å¼€åŽçš„ä»£ç æ˜¯å¦æ ¼å¼åŒ–ï¼Œé»˜è®¤ä¸º `.auto`
  static var formatMode: FormatMode { get }
}
```

- `.auto`ï¼ˆé»˜è®¤ï¼‰ï¼šä½¿ç”¨æ ¼å¼åŒ–åŽçš„å±•å¼€ä»£ç ï¼ŒæŽ¨èä½¿ç”¨ï¼Œèƒ½ä¿æŒä»£ç ä¸€è‡´æ€§ã€‚
- `.disabled`ï¼šå±•å¼€åŽçš„ä»£ç å°†åŽŸæ ·æ’å…¥ï¼Œä¸è¿›è¡Œæ ¼å¼åŒ–ï¼Œé€‚ç”¨äºŽè‡ªå®šä¹‰è¾“å‡ºã€‚

### 5.2 å®çš„åˆ†ç±»åè®®ï¼š`FreestandingMacro` ä¸Ž `AttachedMacro`

åœ¨ `Macro` åè®®çš„åŸºç¡€ä¸Šï¼ŒSwift å°†å®åˆ†ä¸ºä¸¤ç±»ï¼š

- **`FreestandingMacro`**ï¼šç”¨äºŽ **ç‹¬ç«‹ä½¿ç”¨çš„å®**ï¼Œå¯ä»¥ç›´æŽ¥æ’å…¥åˆ°è¡¨è¾¾å¼ã€å£°æ˜Žç­‰ä»»ä½•åœ°æ–¹ï¼Œé€‚åˆç”¨æ¥ç”Ÿæˆç®€å•çš„è¡¨è¾¾å¼ã€‚

```
public protocol FreestandingMacro: Macro { }
```

*  **`AttachedMacro`**ï¼šç”¨äºŽ **é™„ç€åœ¨å·²æœ‰ä»£ç ä¸Šçš„å®**ï¼Œå¿…é¡»ç»‘å®šåˆ°å·²æœ‰çš„ç±»åž‹ã€å±žæ€§ã€å‡½æ•°ç­‰å£°æ˜Žä¸Šï¼Œé€‚åˆå¯¹å·²æœ‰ä»£ç è¿›è¡Œæ‰©å±•ã€‚

```
public protocol AttachedMacro: Macro { }
```

è¿™ä¸¤ä¸ªåè®®æœ¬èº«ä¸å®šä¹‰ä»»ä½•å…·ä½“è¡Œä¸ºï¼Œå®ƒä»¬ä¸ºæ›´ç»†åˆ†çš„è§’è‰²åè®®æä¾›äº†åŸºç¡€ã€‚

> ðŸ’¡ Swift ä½¿ç”¨åè®®ä½“ç³»æ¥è®¾è®¡å®çš„ç›®çš„æ˜¯ï¼š
>
> - **å±‚æ¬¡æ¸…æ™°**ï¼šåŸºç¡€åè®®å®šä¹‰å®çš„å…¬å…±è¡Œä¸ºï¼Œé«˜å±‚åè®®åˆ’åˆ†å®çš„ä½¿ç”¨åœºæ™¯ï¼Œè§’è‰²åè®®å®šä¹‰å®çš„å…·ä½“èƒ½åŠ›ã€‚
> - **ç¼–è¯‘å™¨é©±åŠ¨**ï¼šæ ¹æ®å®çš„è§’è‰²å’Œä½ç½®ï¼Œç¼–è¯‘å™¨è°ƒç”¨ç‰¹å®šåè®®ä¸­çš„ `expansion(...)` æ–¹æ³•å±•å¼€å®ã€‚
> - **ç±»åž‹å®‰å…¨**ï¼šåè®®æ–¹æ³•çš„å®šä¹‰æ˜Žç¡®ï¼Œå±•å¼€æ—¶å¤„ç†çš„è¯­æ³•ç»“æž„ä¸Žä¸Šä¸‹æ–‡ç±»åž‹éƒ½æœ‰ä¸¥æ ¼çš„æ£€æŸ¥ã€‚

### 5.3 å®çš„è§’è‰²åè®®

æ¯ä¸ªå®çš„è§’è‰²éƒ½éœ€è¦å®žçŽ°ä¸€ä¸ªé™æ€æ–¹æ³• `expansion(of:in:)`ï¼Œè¿™æ˜¯ç¼–è¯‘å™¨åœ¨å®å±•å¼€æ—¶è°ƒç”¨çš„æ ¸å¿ƒæ–¹æ³•ã€‚è¯¥æ–¹æ³•å°†æŽ¥æ”¶å½“å‰è¯­æ³•èŠ‚ç‚¹å’Œä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¹¶è¿”å›žç”Ÿæˆçš„è¯­æ³•æ ‘ï¼Œæœ€ç»ˆæ’å…¥åˆ°ç”¨æˆ·ä»£ç ä¸­ã€‚

> ðŸ’¡ **ä¸€ä¸ªå®çš„å®žçŽ°å¯ä»¥éµå¾ªå¤šä¸ªåè®®**ï¼Œä»Žè€Œå…·å¤‡å¤šé‡è§’è‰²èƒ½åŠ›ã€‚
> ä¾‹å¦‚ï¼Œä»¥ä¸‹ `AutoCodableMacro` åŒæ—¶å®žçŽ°äº† `MemberMacro` å’Œ `AccessorMacro`ï¼Œå› æ­¤å®ƒå…·å¤‡ç”Ÿæˆæˆå‘˜å’Œè®¿é—®å™¨çš„èƒ½åŠ›ï¼š

```
public struct AutoCodableMacro: MemberMacro, AccessorMacro {
  public static func expansion(...) -> [DeclSyntax] { ... }

  public static func expansion(...) -> [AccessorDeclSyntax] { ... }
}
```

è¿™æ­£æ˜¯ Swift å®ç³»ç»Ÿçš„å¼ºå¤§ä¹‹å¤„ â€”â€” é€šè¿‡åè®®ç»„åˆå®žçŽ°å®çš„ **å¤šé‡è§’è‰²**ã€‚



### 5.4 ä¸»è¦å®è§’è‰²åè®®

æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä¸€ä¸€è§£æžä¸åŒçš„è§’è‰²åè®®ï¼Œè¯¦ç»†è¯´æ˜Žæ¯ä¸ªåè®®çš„èŒè´£ã€è°ƒç”¨æ—¶æœºåŠé€‚ç”¨åœºæ™¯ã€‚

#### 1. è¡¨è¾¾å¼ç‹¬ç«‹å®ï¼š`ExpressionMacro`

```
public protocol ExpressionMacro: FreestandingMacro {
  static func expansion(
    of node: some FreestandingMacroExpansionSyntax,
    in context: some MacroExpansionContext
  ) throws -> ExprSyntax
}
```

**åŠŸèƒ½**ï¼šæ’å…¥å’Œæ›¿æ¢è¡¨è¾¾å¼ã€‚é€‚ç”¨äºŽåŠ¨æ€è®¡ç®—ã€ç”Ÿæˆå¸¸é‡ã€åŒ…è£…è¡¨è¾¾å¼ç­‰ã€‚

#### 2. å£°æ˜Žå¼ç‹¬ç«‹å®ï¼š`DeclarationMacro`

```
public protocol DeclarationMacro: FreestandingMacro {
  static func expansion(
    of node: some FreestandingMacroExpansionSyntax,
    in context: some MacroExpansionContext
  ) throws -> [DeclSyntax]
}
```

**åŠŸèƒ½**ï¼šç”¨äºŽæ’å…¥æ–°çš„å£°æ˜Žï¼ˆä¾‹å¦‚ï¼Œå˜é‡ã€å‡½æ•°ã€ç±»åž‹å£°æ˜Žç­‰ï¼‰ã€‚

#### 3. å¯¹ç­‰ç»‘å®šå®ï¼š`PeerMacro`

```
public protocol PeerMacro: AttachedMacro {
  static func expansion(
    of node: AttributeSyntax,
    providingPeersOf declaration: some DeclSyntaxProtocol,
    in context: some MacroExpansionContext
  ) throws -> [DeclSyntax]
}
```

**åŠŸèƒ½**ï¼šåœ¨çŽ°æœ‰å£°æ˜Žæ—è¾¹ç”Ÿæˆå¹³çº§ç»“æž„ï¼Œé€šå¸¸ç”¨äºŽæ’å…¥åŒçº§å£°æ˜Žã€‚

#### 4. è®¿é—®å™¨ç»‘å®šå®ï¼š`AccessorMacro`

```
public protocol AccessorMacro: AttachedMacro {
  static func expansion(
    of node: AttributeSyntax,
    providingAccessorsOf declaration: some DeclSyntaxProtocol,
    in context: some MacroExpansionContext
  ) throws -> [AccessorDeclSyntax]
}
```

**åŠŸèƒ½**ï¼šä¸ºå±žæ€§æ·»åŠ è®¿é—®å™¨ï¼ˆå¦‚ `get`ã€`set`ã€`didSet` ç­‰ï¼‰ã€‚

#### 5. æˆå‘˜å±žæ€§ä¿®é¥°å®ï¼š`MemberAttributeMacro`

```
public protocol MemberAttributeMacro: AttachedMacro {
  static func expansion(
    of node: AttributeSyntax,
    attachedTo declaration: some DeclGroupSyntax,
    providingAttributesFor member: some DeclSyntaxProtocol,
    in context: some MacroExpansionContext
  ) throws -> [AttributeSyntax]
}
```

**åŠŸèƒ½**ï¼šä¸ºæˆå‘˜æ·»åŠ ç»Ÿä¸€çš„ä¿®é¥°ç¬¦æˆ–å±žæ€§æ ‡ç­¾ã€‚

#### 6. æˆå‘˜ç»‘å®šå®ï¼š`MemberMacro`

```
public protocol MemberMacro: AttachedMacro {
  static func expansion(
    of node: AttributeSyntax,
    providingMembersOf declaration: some DeclGroupSyntax,
    in context: some MacroExpansionContext
  ) throws -> [DeclSyntax]

  static func expansion(
    of node: AttributeSyntax,
    providingMembersOf declaration: some DeclGroupSyntax,
    conformingTo protocols: [TypeSyntax],
    in context: some MacroExpansionContext
  ) throws -> [DeclSyntax]
}
```

**åŠŸèƒ½**ï¼šä¸ºç±»åž‹æ·»åŠ æˆå‘˜ï¼ˆå¦‚å±žæ€§ã€æ–¹æ³•ã€æž„é€ å™¨ç­‰ï¼‰ã€‚

#### 7. æ›¿æ¢å£°æ˜Žä½“ç»‘å®šå®ï¼š`BodyMacro`

```
public protocol BodyMacro: AttachedMacro {
  static func expansion(
    of node: AttributeSyntax,
    providingBodyFor declaration: some DeclSyntaxProtocol & WithOptionalCodeBlockSyntax,
    in context: some MacroExpansionContext
  ) throws -> [CodeBlockItemSyntax]
}
```

**åŠŸèƒ½**ï¼šä¸ºçŽ°æœ‰å£°æ˜Žæä¾›å…·ä½“å®žçŽ°æˆ–è¡Œä¸ºï¼Œå¸¸ç”¨äºŽç”Ÿæˆè®¡ç®—å±žæ€§çš„å®žçŽ°æˆ–è¡¥å……å‡½æ•°ä½“ã€‚

#### 8. æ‰©å±•ç»‘å®šå®ï¼š`ExtensionMacro`

```
public protocol ExtensionMacro: AttachedMacro {
  static func expansion(
    of node: AttributeSyntax,
    attachedTo declaration: some DeclGroupSyntax,
    providingExtensionsOf type: some TypeSyntaxProtocol,
    conformingTo protocols: [TypeSyntax],
    in context: some MacroExpansionContext
  ) throws -> [ExtensionDeclSyntax]
}
```

**åŠŸèƒ½**ï¼šä¸ºç±»åž‹ç”Ÿæˆæ‰©å±•ï¼Œé€šå¸¸ç”¨äºŽåè®®ä¸€è‡´æ€§ç­‰ã€‚

#### 9. æœªå…¬å¼€ä½¿ç”¨çš„å®žéªŒå®

`CodeItemMacro`ï¼šç”¨äºŽæ’å…¥å®½æ³›çš„ä»£ç ç‰‡æ®µã€‚
`PreambleMacro`ï¼šä¸ºæ–‡ä»¶è‡ªåŠ¨æ³¨å…¥æ–‡ä»¶çº§ä»£ç ã€‚



## 6. å®çš„ç»“æž„è®¾è®¡ï¼šä»Žè§’è‰²åˆ°è¡Œä¸ºçš„æ€ç»´è·¯å¾„

Swift å®ç³»ç»Ÿä¹‹æ‰€ä»¥å¼ºå¤§ï¼Œåœ¨äºŽå®ƒå¹¶ä¸è¿½æ±‚â€œå…¨èƒ½åž‹â€å®ï¼Œè€Œæ˜¯é€šè¿‡â€œè§’è‰²åˆ’åˆ†â€å°†æ¯ç§å®é™åˆ¶åœ¨ç‰¹å®šåœºæ™¯ä¸­ã€‚è¿™ä¸ä»…è®©ç³»ç»Ÿå…·å¤‡ç±»åž‹å®‰å…¨ä¸Žä¸Šä¸‹æ–‡çº¦æŸï¼Œè¿˜å¸®åŠ©å¼€å‘è€…åœ¨è®¾è®¡å®æ—¶å»ºç«‹èµ·æ¸…æ™°çš„æ€ç»´è·¯å¾„ã€‚

æœ¬ç« æˆ‘ä»¬å°†æž„å»ºè¿™æ ·ä¸€ä¸ªæ¨¡åž‹ï¼š**æ¯ä¸€ç§å®çš„â€œè§’è‰²â€ â†’ åº”è¯¥éµå¾ªçš„â€œåè®®â€ â†’ å®žçŽ°çš„â€œè¡Œä¸ºç»“æž„â€**ã€‚

å¹¶é€šè¿‡ä¸€äº›å®žé™…ä¾‹å­ï¼Œå¸®åŠ©ä½ ç†è§£ **å¦‚ä½•åŸºäºŽå®çš„ä½¿ç”¨æ„å›¾ï¼Œé€‰æ‹©æ­£ç¡®çš„åè®®ä¸Žè¾“å‡ºç»“æž„**ã€‚



### 6.1 å®è§’è‰²ç®€æžï¼šä½ è¦æ‰©å±•ä»€ä¹ˆï¼Ÿ

ä¸€ä¸ªå®æ‰€**ä½œç”¨çš„è¯­æ³•ä½ç½®**è¢«ç§°ä¸ºå®ƒçš„ **è§’è‰²ï¼ˆRoleï¼‰**ã€‚è§’è‰²å†³å®šäº†å®èƒ½åº”ç”¨åœ¨å“ªç±»è¯­æ³•ç»“æž„ä¸Šï¼ˆå¦‚è¡¨è¾¾å¼ã€å±žæ€§ã€ç±»åž‹ã€å‡½æ•°ä½“ç­‰ï¼‰ï¼Œä¹Ÿå†³å®šäº†å®å±•å¼€æ—¶èƒ½ç”Ÿæˆå“ªç±»ä»£ç ç»“æž„ã€‚

| ä½ æƒ³åšä»€ä¹ˆï¼Ÿ                         | è§’è‰²åç§°   | ç¤ºä¾‹                |
| ------------------------------------ | ---------- | ------------------- |
| åœ¨è¡¨è¾¾å¼ä¸­æ’å…¥ä»£ç ï¼Ÿ                 | è¡¨è¾¾å¼çº§å® | `#stringify(value)` |
| ä¸º struct è‡ªåŠ¨æ·»åŠ æˆå‘˜ï¼Ÿ             | æˆå‘˜ç»‘å®šå® | `@AddID`            |
| ç”Ÿæˆ computed å±žæ€§çš„ getter/setterï¼Ÿ | å±žæ€§è®¿é—®å® | `@UserDefault`      |
| è‡ªåŠ¨ç”ŸæˆæŸä¸ªå‡½æ•°ä½“ï¼Ÿ                 | å‡½æ•°ä½“å®   | `@AddDescription`   |
| ä¸ºç±»åž‹ç”Ÿæˆåè®®æ‰©å±•å’Œé»˜è®¤å®žçŽ°ï¼Ÿ       | æ‰©å±•ç»‘å®šå® | `@CodableSubclass`  |
| é¢å¤–æ·»åŠ æ—è·¯å‡½æ•°æˆ–ç±»åž‹ï¼Ÿ             | å¯¹ç­‰ç»‘å®šå® | `@BindEvent`        |

æ¯ä¸ªè§’è‰²èƒŒåŽéƒ½å¯¹åº”ç€ä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰ä¸“ç”¨åè®®ï¼Œç”¨æ¥é™åˆ¶å…¶è¡Œä¸ºã€‚



### 6.2 åè®®æ˜¯è§’è‰²çš„å…·è±¡åŒ–

Swift å®åè®®æ˜¯ä»¥ `Macro` ç»“å°¾çš„ä¸€ç»„åè®®ï¼Œå®šä¹‰äº†ä½ åœ¨è¯¥è§’è‰²ä¸‹åº”è¯¥å®žçŽ°çš„æŽ¥å£ã€‚

| è§’è‰²       | å¯¹åº”åè®®               | ä½ è¦è¿”å›žçš„ç»“æž„ç±»åž‹      |
| ---------- | ---------------------- | ----------------------- |
| è¡¨è¾¾å¼çº§å® | `ExpressionMacro`      | `ExprSyntax`            |
| å£°æ˜Žçº§å®   | `DeclarationMacro`     | `[DeclSyntax]`          |
| æˆå‘˜ç»‘å®šå® | `MemberMacro`          | `[DeclSyntax]`          |
| å¯¹ç­‰ç»‘å®šå® | `PeerMacro`            | `[DeclSyntax]`          |
| å±žæ€§è®¿é—®å® | `AccessorMacro`        | `[AccessorDeclSyntax]`  |
| æ‰©å±•ç»‘å®šå® | `ExtensionMacro`       | `[ExtensionDeclSyntax]` |
| æˆå‘˜å±žæ€§å® | `MemberAttributeMacro` | `[AttributeSyntax]`     |
| å‡½æ•°ä½“å®   | `BodyMacro`            | `CodeBlockSyntax`       |

è¿™äº›åè®®éƒ½æä¾›äº†ä¸€ä¸ª `static func expansion(...)` æ–¹æ³•ï¼Œä½†æ ¹æ®è§’è‰²ä¸åŒï¼Œè¿”å›žçš„è¯­æ³•ç»“æž„ä¹Ÿå„ä¸ç›¸åŒã€‚



### 6.3 å»ºç«‹å®çš„è®¾è®¡æ€ç»´è·¯å¾„

å®çš„æœ¬è´¨æ˜¯ **â€œä½ æƒ³è®©å®ƒä¸ºä½ ç”Ÿæˆä»€ä¹ˆä»£ç ï¼Ÿâ€**ï¼Œè¿™å¥—è®¾è®¡è¿‡ç¨‹å¯ä»¥ç®€åŒ–ä¸ºä¸‰æ­¥ï¼š

```
ä½ æƒ³æ‰©å±•çš„ç›®æ ‡ï¼ˆè§’è‰²ï¼‰
     â†“
ç¡®å®šå®åè®®
     â†“
å®žçŽ° expansionï¼Œæž„é€ è¯­æ³•æ ‘ï¼ˆè¡Œä¸ºï¼‰
```

æˆ‘ä»¬å°†è¿™ä¸ªè¿‡ç¨‹ç§°ä¸º**ã€Œè§’è‰² â†’ åè®® â†’ è¡Œä¸ºã€**çš„æ€ç»´æ¨¡åž‹ã€‚

**ä¾‹å­ 1ï¼šæˆ‘æƒ³ä¸º struct æ·»åŠ ä¸€ä¸ªæˆå‘˜ ID**

- â›³ ç›®æ ‡ï¼šä¸º struct æ·»åŠ æˆå‘˜
- ðŸŽ­ è§’è‰²ï¼šæˆå‘˜ç»‘å®šå®ï¼ˆstruct çš„æˆå‘˜ï¼‰
- ðŸ“œ åè®®ï¼š`MemberMacro`
- ðŸ”§ è¡Œä¸ºï¼šè¿”å›ž `DeclSyntax` å½¢å¼çš„å˜é‡å£°æ˜Ž

```
@AddID
struct User { }
```

â†’ å±•å¼€ä¸ºï¼š

```
struct User { 
   var id: String = UUID().uuidString
}
```

**ä¾‹å­ 2ï¼šæˆ‘æƒ³ä¸ºå±žæ€§è‡ªåŠ¨ç”Ÿæˆè®¿é—®å™¨ï¼ˆgetter/setterï¼‰**

- â›³ ç›®æ ‡ï¼šæ›¿å±žæ€§æ·»åŠ è®¿é—®å™¨
- ðŸŽ­ è§’è‰²ï¼šå±žæ€§è®¿é—®å®
- ðŸ“œ åè®®ï¼š`AccessorMacro`
- ðŸ”§ è¡Œä¸ºï¼šè¿”å›ž `[AccessorDeclSyntax]`ï¼Œå¦‚ `get` å’Œ `set`

```
@UserDefault("age")
var age: Int
```

â†’ å±•å¼€ä¸ºï¼š

```
get { UserDefaults.standard.integer(forKey: "age") }
set { UserDefaults.standard.set(newValue, forKey: "age") }
```



**ä¾‹å­ 3ï¼šæˆ‘æƒ³è‡ªåŠ¨ä¸ºæŸä¸ªå‡½æ•°ç”Ÿæˆå®žçŽ°ä½“**

- â›³ ç›®æ ‡ï¼šæ·»åŠ å‡½æ•°ä½“
- ðŸŽ­ è§’è‰²ï¼šå‡½æ•°ä½“å®
- ðŸ“œ åè®®ï¼š`BodyMacro`
- ðŸ”§ è¡Œä¸ºï¼šè¿”å›ž `CodeBlockSyntax`

```
@AddDescription
func description() -> String
```

â†’ å±•å¼€ä¸ºï¼š

```
{
  return "name=\(self.name), age=\(self.age)"
}
```



