# Swift å®ç¼–ç¨‹ï¼šæ·±å…¥ç†è§£è¯­æ³•æ ‘(Syntax)æ“ä½œ

åœ¨æ­£å¼æ·±å…¥äº†è§£ Swift å®ï¼ˆMacroï¼‰å¦‚ä½•ç”Ÿæˆå’Œæ“ä½œä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£ä¸€ä¸ªæœ€åŸºç¡€ã€ä¹Ÿæ˜¯æœ€é‡è¦çš„æ¦‚å¿µï¼š**Syntaxï¼ˆè¯­æ³•èŠ‚ç‚¹ï¼‰**ã€‚

**è¯­æ³•æ ‘(Syntax Tree)** æ˜¯ä»£ç ç”Ÿæˆä¸è½¬æ¢çš„åŸºç¡€æ•°æ®ç»“æ„ã€‚ç†è§£è¯­æ³•æ ‘çš„ç»“æ„å’Œæ“ä½œæ–¹å¼æ˜¯æŒæ¡å®å¼€å‘çš„å…³é”®ç¬¬ä¸€æ­¥ã€‚

## 1. ä»€ä¹ˆæ˜¯ Syntaxï¼Ÿ

ç®€å•æ¥è¯´ï¼Œ**Syntax å°±æ˜¯ Swift ä»£ç çš„ç»“æ„åŒ–è¡¨ç¤º**ï¼Œå°†æ–‡æœ¬ä»£ç è½¬æ¢ä¸ºå…·æœ‰å±‚çº§å…³ç³»çš„èŠ‚ç‚¹æ ‘ã€‚åœ¨Swiftå®ç³»ç»Ÿä¸­ï¼š

``` 
ğŸŸ¡ æºä»£ç  â†’ ğŸŸ¢ è¯æ³•åˆ†æ â†’ ğŸ”µ è¯­æ³•åˆ†æ â†’ ğŸŸ£ è¯­æ³•æ ‘ â†’ ğŸ”´ å®å¤„ç† â†’ ğŸŸ¤ ç¼–è¯‘ 
```

åœ¨ Swift ç¼–è¯‘å™¨å†…éƒ¨ï¼Œæ¯ä¸€è¡Œæºä»£ç ï¼Œéƒ½ä¼šè¢«è§£ææˆä¸€æ£µå·¨å¤§çš„æ ‘çŠ¶ç»“æ„ã€‚è¿™æ£µæ ‘çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œéƒ½æ˜¯ä¸€ä¸ª **Syntax èŠ‚ç‚¹**ï¼Œä»£è¡¨ç€æºä»£ç ä¸­çš„ä¸€éƒ¨åˆ†ã€‚ä¾‹å¦‚ï¼š

| èŠ‚ç‚¹ç±»åˆ«   | ç¤ºä¾‹ç±»å‹                  | å¯¹åº”ä»£ç ç¤ºä¾‹    |
| :--------- | :------------------------ | :-------------- |
| è¡¨è¾¾å¼èŠ‚ç‚¹ | `InfixOperatorExprSyntax` | `a + b`         |
| å£°æ˜èŠ‚ç‚¹   | `VariableDeclSyntax`      | `let x = 1`     |
| è¯­å¥èŠ‚ç‚¹   | `ReturnStmtSyntax`        | `return result` |
| ç±»å‹èŠ‚ç‚¹   | `TypeAnnotationSyntax`    | `: Int`         |

æ¯ç§è¯­æ³•ç»“æ„ï¼Œåœ¨ Swift å®ç³»ç»Ÿä¸­éƒ½æœ‰ä¸“é—¨å¯¹åº”çš„ **Syntax ç±»å‹**æ¥æè¿°ã€‚



## 2. ä¸ºä»€ä¹ˆ Swift å®æ“ä½œçš„æ˜¯ Syntaxï¼Ÿ

åœ¨ Swift å®ä¸­ï¼Œä½ ä¸æ˜¯ç›´æ¥æ“ä½œå­—ç¬¦ä¸²æ–‡æœ¬ï¼Œä¹Ÿä¸æ˜¯ç›´æ¥ä¿®æ”¹æºä»£ç ï¼Œè€Œæ˜¯ï¼š

ğŸŸ¡ **è¯»å– Syntax** â†’  ğŸŸ¢ **ç”Ÿæˆæ–°çš„ Syntax** â†’  ğŸ”µ **äº¤ç»™ç¼–è¯‘å™¨ç»§ç»­å¤„ç†**

**åŸå› æ˜¯ï¼š**

- **å®‰å…¨æ€§**é«˜ï¼ˆä¸ä¼šç”Ÿæˆéæ³•ä»£ç ï¼‰
- **ç»“æ„æ¸…æ™°**ï¼ˆæ¯ä¸€éƒ¨åˆ†éƒ½èƒ½ç»†ç²’åº¦æ§åˆ¶ï¼‰
- **è‡ªåŠ¨æ ¼å¼åŒ–**ï¼ˆä¸ä¼šç ´åä»£ç é£æ ¼ï¼‰
- **æ˜“äºç¼–è¯‘å™¨ä¼˜åŒ–**ï¼ˆç¼–è¯‘å™¨ç›´æ¥ç†è§£ä½ çš„å®ç»“æœï¼‰

æ‰€ä»¥ï¼Œä½ å¯ä»¥æŠŠ Swift å®æƒ³è±¡æˆæ˜¯åœ¨**ç¼–è¾‘ä¸€æ£µä»£ç æ ‘ï¼ˆSyntax Treeï¼‰**ã€‚
è€Œä½ çš„ä»»åŠ¡ï¼Œå°±æ˜¯åœ¨è¿™æ£µæ ‘ä¸Šæ’å…¥ã€ä¿®æ”¹ã€æ›¿æ¢èŠ‚ç‚¹ã€‚



## 3. æ€ä¹ˆç†è§£ Syntax çš„ç»“æ„ï¼Ÿ

å¯ä»¥ç”¨ä¸€å¼ ç®€å•å›¾ç†è§£ï¼š

```
æºä»£ç 
 â””â”€â”€> è¯æ³•åˆ†æï¼ˆTokenizeï¼‰
       â””â”€â”€> è¯­æ³•åˆ†æï¼ˆParseï¼‰
             â””â”€â”€> ç”Ÿæˆ Syntax Treeï¼ˆè¯­æ³•æ ‘ï¼‰
```

æ¯ä¸ª Syntax èŠ‚ç‚¹éƒ½æœ‰ï¼š

- **èŠ‚ç‚¹ç±»å‹**ï¼ˆæ¯”å¦‚è¡¨è¾¾å¼ã€å£°æ˜ã€ç±»å‹ç­‰ï¼‰
- **å­èŠ‚ç‚¹**ï¼ˆä¾‹å¦‚å‡½æ•°è°ƒç”¨æœ‰å‡½æ•°åã€å‚æ•°åˆ—è¡¨å­èŠ‚ç‚¹ï¼‰
- **æºä»£ç ä½ç½®ä¿¡æ¯**ï¼ˆå¯ä»¥å®šä½åˆ°å…·ä½“ä»£ç è¡Œåˆ—ï¼‰
- **æè¿°ä¿¡æ¯**ï¼ˆå¯ä»¥è¾“å‡ºæºä»£ç ç‰‡æ®µï¼‰

æ¯”å¦‚ï¼š

```
print(a + b)
```

å¯¹åº”çš„ Syntax æ ‘ç»“æ„å¤§è‡´æ˜¯ï¼š

```
FunctionCallExprSyntax
â”œâ”€â”€ calledExpression: DeclReferenceExprSyntax                 // ä¸æ˜¯ IdentifierExprSyntax
â”‚   â””â”€â”€ baseName: .identifier("print")                        // æ ‡è¯†ç¬¦èŠ‚ç‚¹
â”œâ”€â”€ leftParen: .leftParen                                     // å·¦æ‹¬å·
â”œâ”€â”€ arguments: LabeledExprListSyntax                          // å‚æ•°åˆ—è¡¨
â”‚   â””â”€â”€ [0]: LabeledExprSyntax                                // å‚æ•°å…ƒç´ 
â”‚       â”œâ”€â”€ expression: InfixOperatorExprSyntax               // ä¸­ç¼€è¡¨è¾¾å¼
â”‚       â”‚   â”œâ”€â”€ leftOperand: DeclReferenceExprSyntax("a")
â”‚       â”‚   â”œâ”€â”€ operator: BinaryOperatorExprSyntax("+")
â”‚       â”‚   â””â”€â”€ rightOperand: DeclReferenceExprSyntax("b")
â””â”€â”€ rightParen: .rightParen                                   // å³æ‹¬å·
```

è¿™ç§æ ‘å½¢ç»“æ„ç¡®å®ä½“ç°äº†å®ç³»ç»Ÿçš„æ ¸å¿ƒä¼˜åŠ¿ï¼š

| ç‰¹æ€§         | è¯­æ³•æ ‘ä½“ç°                                                   | å®ç³»ç»Ÿæ”¶ç›Š               |
| :----------- | :----------------------------------------------------------- | :----------------------- |
| **å±‚æ¬¡åŒ–**   | è¡¨è¾¾å¼åµŒå¥—ï¼ˆ`InfixOperatorExpr` ä½œä¸º `FunctionCall` çš„å­èŠ‚ç‚¹ï¼‰ | å…è®¸é€’å½’å¤„ç†å¤æ‚è¡¨è¾¾å¼   |
| **ç±»å‹å®‰å…¨** | æ¯ä¸ªèŠ‚ç‚¹ç±»å‹æ˜ç¡®ï¼ˆå¦‚åŒºåˆ† `DeclReference` å’Œ `BinaryOperator`ï¼‰ | ç¼–è¯‘æ—¶éªŒè¯ç”Ÿæˆä»£ç åˆæ³•æ€§ |
| **å¯ç»„åˆæ€§** | ç‹¬ç«‹èŠ‚ç‚¹é€šè¿‡çˆ¶å­å…³ç³»ç»„åˆï¼ˆå¦‚æ“ä½œç¬¦å·¦å³æ“ä½œæ•°ï¼‰               | æ”¯æŒæ¨¡å—åŒ–ä»£ç ç”Ÿæˆ       |
| **ç²¾å‡†å®šä½** | æ¯ä¸ªèŠ‚ç‚¹åŒ…å«ä½ç½®ä¿¡æ¯ï¼ˆleading/trailing triviaï¼‰              | å®ç°ç²¾ç¡®çš„é”™è¯¯è¯Šæ–­       |



## 4. ä¸€ä¸ªå°ä¾‹å­ï¼šæ‰‹åŠ¨åˆ›å»º Syntax

åœ¨ Swift å®ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸éœ€è¦æ‰‹åŠ¨æ„é€  `Syntax` èŠ‚ç‚¹æ¥è¡¨ç¤ºè¡¨è¾¾å¼ã€‚

æ¯”å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æƒ³åœ¨å®é‡Œè¿”å› `1 + 2`ï¼Œå¯ä»¥ç›´æ¥å†™ï¼š

```
let expr: ExprSyntax = "1 + 2"
```

è¿™é‡Œçš„ `"1 + 2"` ä¼šè¢«è§£é‡Šæˆä¸€ä¸ª `InfixOperatorExprSyntax` èŠ‚ç‚¹ï¼Œä»£è¡¨åŠ æ³•æ“ä½œã€‚

å¦‚æœéœ€è¦æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨æ„å»ºæ¯ä¸€éƒ¨åˆ†ï¼Œæ¯”å¦‚ï¼š

```
let one = ExprSyntax("1")
let two = ExprSyntax("2")
let oper = TokenSyntax.binaryOperator("+")
let plusExpr = InfixOperatorExprSyntax(
    leftOperand: one,
    operator: oper,
    rightOperand: two
)
```

è¿™ç§æ–¹å¼è™½ç„¶æ›´ç¹çï¼Œä½†å¯ä»¥å®Œå…¨æŒæ§èŠ‚ç‚¹ç»“æ„ï¼Œé€‚ç”¨äºéœ€è¦ç²¾ç¡®ç”Ÿæˆå¤æ‚ä»£ç çš„åœºæ™¯ã€‚

ä¸è¿‡â€”â€”å½“æˆ‘ä»¬åªéœ€è¦è¿”å›ä¸€ä¸ªç®€å•çš„æ•°å€¼æˆ–è€…è¿ç®—ç»“æœæ—¶ï¼Œè¿™ç§æ‰‹åŠ¨æ„é€ çš„æ–¹å¼æœªå…å¤ªé‡äº†ã€‚
è¿™æ—¶ï¼Œå°±å¯ä»¥ç”¨ä¸€ç§æ›´åŠ ç®€æ´çš„æ–¹å¼ â€”â€” `\(raw:)`ã€‚



## 5.  `\(raw:)`ï¼šæ›´é«˜æ•ˆåœ°è¿”å› Syntax

ä¸¾ä¸ªå®é™…çš„ä¾‹å­ï¼š

å‡è®¾æˆ‘ä»¬å®ç°äº†ä¸€ä¸ª `sum` å®ï¼Œå¯ä»¥å°†ä¼ å…¥çš„æ•´æ•°è¿›è¡Œæ±‚å’Œã€‚

```
@freestanding(expression)
public macro sum(_ values: Int...) -> Int = #externalMacro(module: "McccMacros", type: "SumMacro")
```

å¯¹åº”çš„å®å®ç°ï¼š

```
public struct SumMacro: ExpressionMacro {
    public static func expansion(
        of node: some FreestandingMacroExpansionSyntax,
        in context: some MacroExpansionContext
    ) throws -> ExprSyntax {
        
        // è§£ææ‰€æœ‰å‚æ•°ï¼Œç¡®ä¿æ˜¯æ•´æ•°
        let values: [Int] = try node.arguments.map { element in
            guard let literalExpr = element.expression.as(IntegerLiteralExprSyntax.self),
                  let intValue = Int(literalExpr.literal.text) else {
                throw ASTError("All arguments to #sum must be integer literals.")
            }
            return intValue
        }
        
        // è®¡ç®—æ€»å’Œ
        let sum = values.reduce(0, +)

        // ç›´æ¥è¿”å›è¡¨è¾¾å¼
        return "\(raw: sum)"
    }
}
```

è°ƒç”¨ç¤ºä¾‹ï¼š

```
let total = #sum(1, 2, 3, 4)
```

å®å±•å¼€åç­‰åŒäºï¼š

```
let total = 10
```

è¿™é‡Œçš„å…³é”®å°±æ˜¯ï¼š

```
return "\(raw: sum)"
```

è¿™è¡Œä»£ç å‘Šè¯‰ç¼–è¯‘å™¨ï¼š**æŠŠ `sum` çš„å€¼ä½œä¸ºè¡¨è¾¾å¼ç›´æ¥æ’è¿›å»ï¼Œè€Œä¸æ˜¯ä½œä¸ºå­—ç¬¦ä¸²å¤„ç†ã€‚**

å¦‚æœä½ ç›´æ¥ `"\(sum)"`ï¼Œå…¶å®æ’è¿›å»çš„æ˜¯å­—ç¬¦ä¸² `"10"`ï¼Œè€Œä¸æ˜¯æ•°å­— `10`ã€‚
ä½¿ç”¨ `\(raw:)` å¯ä»¥ä¿è¯ç”Ÿæˆçš„ä»£ç ç»“æ„æ­£ç¡®ï¼Œæ˜¯åˆæ³•ä¸”å¯ç¼–è¯‘çš„ Swift ä»£ç ã€‚

### ä¸ºä»€ä¹ˆè¦ç”¨ (raw:)ï¼Ÿ

- ä¿æŒç±»å‹æ­£ç¡®æ€§ï¼ˆæ¯”å¦‚æ•°å­—å°±æ˜¯æ•°å­—ï¼Œè¡¨è¾¾å¼å°±æ˜¯è¡¨è¾¾å¼ï¼‰
- é¿å…å­—ç¬¦ä¸²åŒ…è£¹ï¼ˆé˜²æ­¢å‡ºç° `"10"` è¿™ç§éé¢„æœŸç»“æœï¼‰
- ç›´æ¥ç”Ÿæˆåˆæ³•çš„ Syntax èŠ‚ç‚¹



## 6. å°ç»“

åœ¨ Swift å®é‡Œï¼Œ**Syntax å°±æ˜¯ä½ çš„"ç§¯æœ¨å—"**ï¼Œä½ éœ€è¦é€šè¿‡æ“ä½œè¿™äº›ç§¯æœ¨å—ï¼Œæ­å»ºå‡ºæ–°çš„ä»£ç ä¸–ç•Œã€‚


åœ¨äº†è§£äº† Syntax æ˜¯ä»€ä¹ˆä¹‹åï¼Œå°±è¦æ­£å¼å­¦ä¹ å¦‚ä½•åŸºäº Syntax èŠ‚ç‚¹æ¥æ„å»ºè¡¨è¾¾å¼å®äº†ï¼





