# Swift Macros - å®ä¹‹è¯­æ³•æ ‘

åœ¨æ­£å¼æ·±å…¥å®çš„ä¸–ç•Œä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»ç†è§£ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š**Syntaxï¼ˆè¯­æ³•èŠ‚ç‚¹ï¼‰**ã€‚å®ƒä¸ä»…æ˜¯ Swift å®ç”Ÿæˆå’Œæ“ä½œä»£ç çš„â€œåŸææ–™â€ï¼Œæ›´æ˜¯ç¼–è¯‘å™¨ç†è§£ä»£ç ç»“æ„çš„åŸºç¡€ã€‚

**è¯­æ³•æ ‘(Syntax Tree)** æ˜¯ä»£ç ç”Ÿæˆä¸è½¬æ¢çš„åŸºç¡€æ•°æ®ç»“æ„ã€‚ç†è§£è¯­æ³•æ ‘çš„ç»“æ„å’Œæ“ä½œæ–¹å¼æ˜¯æŒæ¡å®å¼€å‘çš„å…³é”®ç¬¬ä¸€æ­¥ã€‚

æœ¬ç¯‡æ–‡ç« æ—¨åœ¨å¸®åŠ©ä½ æŒæ¡ SwiftSyntax æä¾›çš„è¯­æ³•èŠ‚ç‚¹ä½“ç³»ã€å¦‚ä½•ä»è¯­æ³•æ ‘ä¸­æå–ä¿¡æ¯ã€å¦‚ä½•æ„å»ºè¯­æ³•æ ‘ï¼Œä»¥åŠè¿™äº›èƒ½åŠ›åœ¨å®ä¸­çš„å®æˆ˜åº”ç”¨ï¼Œä¸ºä½ åç»­ç†è§£å®åè®®ä¸å®å®ç°æ‰“ä¸‹æ‰å®çš„åŸºç¡€ã€‚



## 1. ä¸ºä»€ä¹ˆéœ€è¦äº†è§£è¯­æ³•æ ‘

åœ¨ Swift å®ä¸­ï¼š

- ä½ å¤„ç†çš„ä¸æ˜¯â€œå­—ç¬¦ä¸²ä»£ç â€ï¼Œè€Œæ˜¯ç»“æ„åŒ–çš„ **è¯­æ³•æ ‘**
- å®çš„è¾“å…¥æ˜¯è¯­æ³•èŠ‚ç‚¹ï¼Œè¾“å‡ºä¹Ÿæ˜¯è¯­æ³•èŠ‚ç‚¹
- å®çš„å‚æ•°ã€ä¸Šä¸‹æ–‡ã€è¿”å›å€¼éƒ½æ¥è‡ªè¯­æ³•ç»“æ„

ç®€è¨€ä¹‹ï¼š**ä¸äº†è§£è¯­æ³•æ ‘ï¼Œå°±æ— æ³•ç†è§£å®çš„å·¥ä½œæ–¹å¼ã€‚**



## 2. Syntax ä¸ SwiftSyntax

### 2.1 ä»€ä¹ˆæ˜¯ Syntaxï¼Ÿ

`Syntax` æ˜¯å¯¹ Swift æºä»£ç çš„ç»“æ„åŒ–è¡¨ç¤ºã€‚Swift ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶ï¼Œå°†æºä»£ç ä¾æ¬¡è½¬æ¢ä¸ºï¼š

``` 
ğŸŸ¡ æºä»£ç  â†’ ğŸŸ¢ è¯æ³•åˆ†æ â†’ ğŸ”µ è¯­æ³•åˆ†æ â†’ ğŸŸ£ è¯­æ³•æ ‘ â†’ ğŸ”´ å®å¤„ç† â†’ ğŸŸ¤ ç¼–è¯‘ 
```

æ¯ä¸€è¡Œ Swift ä»£ç ï¼Œéƒ½ä¼šè¢«è§£æä¸ºä¸€æ£µæ ‘çŠ¶ç»“æ„ï¼Œæ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªè¯­æ³•ç‰‡æ®µï¼Œç§°ä¸º **Syntax èŠ‚ç‚¹ï¼ˆSyntax Nodeï¼‰**ã€‚



### 2.2 å¸¸è§è¯­æ³•èŠ‚ç‚¹ç±»å‹ä¸¾ä¾‹

| èŠ‚ç‚¹ç±»åˆ«   | ç¤ºä¾‹ç±»å‹                  | å¯¹åº”ä»£ç ç¤ºä¾‹    |
| ---------- | ------------------------- | --------------- |
| è¡¨è¾¾å¼èŠ‚ç‚¹ | `InfixOperatorExprSyntax` | `a + b`         |
| å£°æ˜èŠ‚ç‚¹   | `VariableDeclSyntax`      | `let x = 1`     |
| è¯­å¥èŠ‚ç‚¹   | `ReturnStmtSyntax`        | `return result` |
| ç±»å‹èŠ‚ç‚¹   | `TypeAnnotationSyntax`    | `: Int`         |

æ¯ç§èŠ‚ç‚¹ç±»å‹éƒ½æœ‰æ˜ç¡®çš„ç»“æ„å®šä¹‰ï¼Œå¯é€šè¿‡ SwiftSyntax æ“ä½œã€‚



### 2.3 ä¸ºä»€ä¹ˆå®æ“ä½œçš„æ˜¯ Syntaxï¼Ÿ

åœ¨ Swift å®ä¸­ï¼Œä½ ä¸æ˜¯ç›´æ¥æ“ä½œå­—ç¬¦ä¸²æ–‡æœ¬ï¼Œä¹Ÿä¸æ˜¯ç›´æ¥ä¿®æ”¹æºä»£ç ï¼Œè€Œæ˜¯ï¼š

ğŸŸ¡ **è¯»å– Syntax** â†’  ğŸŸ¢ **ç”Ÿæˆæ–°çš„ Syntax** â†’  ğŸ”µ **äº¤ç»™ç¼–è¯‘å™¨ç»§ç»­å¤„ç†**

ç›´æ¥æ“ä½œç»“æ„åŒ–çš„è¯­æ³•æ ‘ï¼Œèƒ½å¸¦æ¥ï¼š

| ä¼˜åŠ¿       | è¯´æ˜                                       |
| ---------- | ------------------------------------------ |
| å®‰å…¨æ€§é«˜   | ç”Ÿæˆçš„è¯­æ³•ç»“æ„ä¸ä¼šå¯¼è‡´éæ³•ä»£ç              |
| å¯è¯»æ€§å¼º   | ç»“æ„æ¸…æ™°ï¼Œæ˜“äºè°ƒè¯•å’Œç†è§£                   |
| è‡ªåŠ¨æ ¼å¼åŒ– | ç¼–è¯‘å™¨å¯è‡ªåŠ¨å¯¹é½é£æ ¼ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒæ•´         |
| æ˜“äºä¼˜åŒ–   | ç¼–è¯‘å™¨ç›´æ¥ç†è§£è¯­æ³•ç»“æ„ï¼Œå¯æ‰§è¡Œæ›´æ™ºèƒ½çš„ä¼˜åŒ– |

æ‰€ä»¥ï¼Œä½ å¯ä»¥æŠŠ Swift å®æƒ³è±¡æˆæ˜¯åœ¨**ç¼–è¾‘ä¸€æ£µä»£ç æ ‘ï¼ˆSyntax Treeï¼‰**ï¼Œè€Œä½ çš„ä»»åŠ¡ï¼Œå°±æ˜¯åœ¨è¿™æ£µæ ‘ä¸Šæ’å…¥ã€ä¿®æ”¹ã€æ›¿æ¢èŠ‚ç‚¹ã€‚



### 2.3 è¯­æ³•æ ‘ç»“æ„ç¤ºæ„

å¯ä»¥ç”¨ä¸€å¼ ç®€å•å›¾ç†è§£ï¼š

```
æºä»£ç 
 â””â”€â”€> è¯æ³•åˆ†æï¼ˆTokenizeï¼‰
       â””â”€â”€> è¯­æ³•åˆ†æï¼ˆParseï¼‰
             â””â”€â”€> ç”Ÿæˆ Syntax Treeï¼ˆè¯­æ³•æ ‘ï¼‰
```

æ¯ä¸ª Syntax èŠ‚ç‚¹éƒ½æœ‰ï¼š

- **èŠ‚ç‚¹ç±»å‹**ï¼ˆæ¯”å¦‚è¡¨è¾¾å¼ã€å£°æ˜ã€ç±»å‹ç­‰ï¼‰
- **å­èŠ‚ç‚¹**ï¼ˆä¾‹å¦‚å‡½æ•°è°ƒç”¨æœ‰å‡½æ•°åã€å‚æ•°åˆ—è¡¨å­èŠ‚ç‚¹ï¼‰
- **æºä»£ç ä½ç½®ä¿¡æ¯**ï¼ˆå¯ä»¥å®šä½åˆ°å…·ä½“ä»£ç è¡Œåˆ—ï¼‰
- **æè¿°ä¿¡æ¯**ï¼ˆå¯ä»¥è¾“å‡ºæºä»£ç ç‰‡æ®µï¼‰

ä»¥ä»£ç  `print(a + b)` ä¸ºä¾‹ï¼Œå®ƒçš„è¯­æ³•æ ‘å¤§è‡´å¦‚ä¸‹ï¼š

å¯¹åº”çš„ Syntax æ ‘ç»“æ„å¤§è‡´æ˜¯ï¼š

```
FunctionCallExprSyntax
â”œâ”€â”€ calledExpression: DeclReferenceExprSyntax                 // ä¸æ˜¯ IdentifierExprSyntax
â”‚   â””â”€â”€ baseName: .identifier("print")                        // æ ‡è¯†ç¬¦èŠ‚ç‚¹
â”œâ”€â”€ leftParen: .leftParen                                     // å·¦æ‹¬å·
â”œâ”€â”€ arguments: LabeledExprListSyntax                          // å‚æ•°åˆ—è¡¨
â”‚   â””â”€â”€ [0]: LabeledExprSyntax                                // å‚æ•°å…ƒç´ 
â”‚       â”œâ”€â”€ expression: InfixOperatorExprSyntax               // ä¸­ç¼€è¡¨è¾¾å¼
â”‚       â”‚   â”œâ”€â”€ leftOperand: DeclReferenceExprSyntax("a")
â”‚       â”‚   â”œâ”€â”€ operator: BinaryOperatorExprSyntax("+")
â”‚       â”‚   â””â”€â”€ rightOperand: DeclReferenceExprSyntax("b")
â””â”€â”€ rightParen: .rightParen                                   // å³æ‹¬å·
```

è¿™ç§æ ‘å½¢ç»“æ„ç¡®å®ä½“ç°äº†å®ç³»ç»Ÿçš„æ ¸å¿ƒä¼˜åŠ¿ï¼š

| ç‰¹æ€§         | è¯­æ³•æ ‘ä½“ç°                                                   | å®ç³»ç»Ÿæ”¶ç›Š               |
| :----------- | :----------------------------------------------------------- | :----------------------- |
| **å±‚æ¬¡åŒ–**   | è¡¨è¾¾å¼åµŒå¥—ï¼ˆ`InfixOperatorExpr` ä½œä¸º `FunctionCall` çš„å­èŠ‚ç‚¹ï¼‰ | å…è®¸é€’å½’å¤„ç†å¤æ‚è¡¨è¾¾å¼   |
| **ç±»å‹å®‰å…¨** | æ¯ä¸ªèŠ‚ç‚¹ç±»å‹æ˜ç¡®ï¼ˆå¦‚åŒºåˆ† `DeclReference` å’Œ `BinaryOperator`ï¼‰ | ç¼–è¯‘æ—¶éªŒè¯ç”Ÿæˆä»£ç åˆæ³•æ€§ |
| **å¯ç»„åˆæ€§** | ç‹¬ç«‹èŠ‚ç‚¹é€šè¿‡çˆ¶å­å…³ç³»ç»„åˆï¼ˆå¦‚æ“ä½œç¬¦å·¦å³æ“ä½œæ•°ï¼‰               | æ”¯æŒæ¨¡å—åŒ–ä»£ç ç”Ÿæˆ       |
| **ç²¾å‡†å®šä½** | æ¯ä¸ªèŠ‚ç‚¹åŒ…å«ä½ç½®ä¿¡æ¯ï¼ˆleading/trailing triviaï¼‰              | å®ç°ç²¾ç¡®çš„é”™è¯¯è¯Šæ–­       |





### 2.5 SwiftSyntax çš„åè®®ä½“ç³»

SwiftSyntax ä¸­çš„èŠ‚ç‚¹éƒ½éµå¾ªä¸€å¥—åè®®ï¼š

| åè®®å               | æè¿°               |
| -------------------- | ------------------ |
| `SyntaxProtocol`     | æ‰€æœ‰èŠ‚ç‚¹çš„åŸºç±»åè®® |
| `DeclSyntaxProtocol` | å£°æ˜ç±»èŠ‚ç‚¹         |
| `ExprSyntaxProtocol` | è¡¨è¾¾å¼ç±»èŠ‚ç‚¹       |
| `TypeSyntaxProtocol` | ç±»å‹ç›¸å…³èŠ‚ç‚¹       |
| `StmtSyntaxProtocol` | è¯­å¥èŠ‚ç‚¹           |

è¿™äº›åè®®èƒ½å¸®åŠ©ä½ åœ¨ä»£ç ä¸­è¿›è¡Œç»Ÿä¸€æ“ä½œä¸ç±»å‹åŒ¹é…ã€‚





## 3. å¦‚ä½•ä»è¯­æ³•æ ‘ä¸­æå–ä¿¡æ¯ï¼Ÿ

### 3.1 `.as(...)` ç±»å‹è½¬æ¢

```
if let call = expr.as(FunctionCallExprSyntax.self) {
    let functionName = call.calledExpression.description
}
```

### 3.2 è®¿é—®èŠ‚ç‚¹å­—æ®µ

```
let structDecl = decl.as(StructDeclSyntax.self)
let name = structDecl?.identifier.text
let members = structDecl?.memberBlock.members
```

### 3.3 éå†å­èŠ‚ç‚¹

```
for child in node.children(viewMode: .all) {
    print(child.syntaxNodeType)
}
```



## 4. å¦‚ä½•æ„å»ºè¯­æ³•èŠ‚ç‚¹ï¼Ÿ

### 4.1 ä½¿ç”¨å­—ç¬¦ä¸²æ„é€ 

```
let expr: ExprSyntax = "1 + 2"
```

è¿™æ˜¯æœ€å¸¸ç”¨ä¸”ä¾¿æ·çš„æ„é€ æ–¹å¼ï¼Œé€‚åˆç®€å•çš„å®è¾“å‡ºåœºæ™¯ã€‚

### 4.2 ä½¿ç”¨ SwiftSyntaxBuilder æ„é€ å¤æ‚ç»“æ„

```
let one = ExprSyntax("1")
let two = ExprSyntax("2")
let plus = TokenSyntax.binaryOperator("+")
let expr = InfixOperatorExprSyntax(
    leftOperand: one,
    operatorOperand: plus,
    rightOperand: two
)
```

é€‚ç”¨äºéœ€è¦æ§åˆ¶æ¯ä¸ªç»„æˆéƒ¨åˆ†ã€ç”Ÿæˆå¤æ‚ç»“æ„çš„å®å®ç°ã€‚



## 5. `\(raw:)`ï¼šå®‰å…¨æ’å…¥è¯­æ³•èŠ‚ç‚¹

Swift å®è¿”å› `ExprSyntax` æ—¶å¸¸è§å†™æ³•æ˜¯ï¼š

```
return "\(raw: value)"
```

è¿™å’Œæ™®é€šçš„å­—ç¬¦ä¸²æ’å€¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

* é”™è¯¯å†™æ³•ï¼šç”Ÿæˆçš„æ˜¯å­—ç¬¦ä¸²

```
let sum = 10
return "\(sum)" // å®é™…ç”Ÿæˆçš„æ˜¯å­—ç¬¦ä¸²å­—é¢é‡ "10"
```

* æ­£ç¡®å†™æ³•ï¼šä½¿ç”¨ `raw:` æ’å…¥è¡¨è¾¾å¼

```
let sum = 10
return "\(raw: sum)" // ç”ŸæˆçœŸæ­£çš„æ•°å­—è¡¨è¾¾å¼ 10
```

### ä¸ºä»€ä¹ˆæ¨èä½¿ç”¨ `\(raw:)`ï¼Ÿ

| åœºæ™¯       | ä¸ä½¿ç”¨ raw            | ä½¿ç”¨ raw            |
| ---------- | --------------------- | ------------------- |
| æ’å…¥ Int   | `"10"`ï¼ˆå­—ç¬¦ä¸²ï¼‰      | `10`ï¼ˆæ•°å­—ï¼‰        |
| æ’å…¥è¡¨è¾¾å¼ | `"(a + b)"`ï¼ˆå­—ç¬¦ä¸²ï¼‰ | `a + b`ï¼ˆè¯­æ³•ç»“æ„ï¼‰ |

è¿™èƒ½ç¡®ä¿ç”Ÿæˆçš„æ˜¯ **åˆæ³•çš„è¯­æ³•èŠ‚ç‚¹**ï¼Œè€Œéæ‹¼æ¥çš„å­—ç¬¦ä¸²ï¼Œé¿å…ç±»å‹é”™è¯¯ã€‚

- ä¿æŒç±»å‹æ­£ç¡®æ€§ï¼ˆæ¯”å¦‚æ•°å­—å°±æ˜¯æ•°å­—ï¼Œè¡¨è¾¾å¼å°±æ˜¯è¡¨è¾¾å¼ï¼‰
- é¿å…å­—ç¬¦ä¸²åŒ…è£¹ï¼ˆé˜²æ­¢å‡ºç° `"10"` è¿™ç§éé¢„æœŸç»“æœï¼‰
- ç›´æ¥ç”Ÿæˆåˆæ³•çš„ Syntax èŠ‚ç‚¹



### 6. ç¤ºä¾‹ï¼šå®ç°ä¸€ä¸ªè¡¨è¾¾å¼å® `#sum(...)`

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„å®ï¼Œå®ƒå¯ä»¥å°†å¤šä¸ªæ•´æ•°å‚æ•°ç›¸åŠ ï¼š

### å®å£°æ˜

```
@freestanding(expression)
public macro sum(_ values: Int...) -> Int = #externalMacro(module: "McccMacros", type: "SumMacro")
```

### å®å®ç°

```
public struct SumMacro: ExpressionMacro {
    public static func expansion(
        of node: some FreestandingMacroExpansionSyntax,
        in context: some MacroExpansionContext
    ) throws -> ExprSyntax {
        
        // è§£ææ‰€æœ‰å‚æ•°ï¼Œç¡®ä¿æ˜¯æ•´æ•°
        let values: [Int] = try node.arguments.map { element in
            guard let literalExpr = element.expression.as(IntegerLiteralExprSyntax.self),
                  let intValue = Int(literalExpr.literal.text) else {
                throw ASTError("All arguments to #sum must be integer literals.")
            }
            return intValue
        }
        
        // è®¡ç®—æ€»å’Œ
        let sum = values.reduce(0, +)

        // ç›´æ¥è¿”å›è¡¨è¾¾å¼
        return "\(raw: sum)"
    }
}
```



### ä½¿ç”¨ç¤ºä¾‹

```
let total = #sum(1, 2, 3, 4)
```

å®å±•å¼€åï¼š

```
let total = 10
```





## 6. å°ç»“

åœ¨ Swift å®ç³»ç»Ÿä¸­ï¼Œä½ è¦æŒæ¡çš„ä¸æ˜¯å­—ç¬¦ä¸²æ‹¼æ¥æŠ€å·§ï¼Œè€Œæ˜¯ï¼š

- å¦‚ä½•è¯†åˆ«è¯­æ³•èŠ‚ç‚¹ç±»å‹ï¼ˆå¦‚å‡½æ•°ã€å˜é‡ã€è¡¨è¾¾å¼ï¼‰
- å¦‚ä½•æå–èŠ‚ç‚¹ä¿¡æ¯ï¼ˆåç§°ã€å‚æ•°ã€å±æ€§ç­‰ï¼‰
- å¦‚ä½•æ„å»ºè¯­æ³•ç»“æ„ï¼ˆè¡¨è¾¾å¼ã€è¯­å¥ã€å£°æ˜ç­‰ï¼‰
- å¦‚ä½•æ’å…¥è¯­æ³•èŠ‚ç‚¹ï¼ˆä½¿ç”¨ `\(raw:)` ä¿è¯ç»“æ„åˆæ³•ï¼‰

**è¯­æ³•æ ‘æ˜¯å®ç³»ç»Ÿçš„â€œè¯­è¨€â€ï¼Œä¹Ÿæ˜¯å®ç”Ÿæˆä»£ç çš„å”¯ä¸€é€šé“ã€‚**

